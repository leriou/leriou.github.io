<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="海量用户标签的存储方案背景我们在日常的工作中经常遇到这种场景 对一个用户添加许多的标签信息方便对用户身份进行搜索和精细化运营  ps:本文我们不考虑用户身上的标签是怎么来的,只讨论用户已经拥有标签的情况下怎么进行存储  需求分析我们给用户做标签的目的是为了支持更加精细化的运营,算是用户画像的一部分,用户的标签来源可能跟消费,登录,浏览等记录都有关系 我们要做的是可以根据用户身上已经存在的标签,筛选">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Bitmap来存储海量用户标签系统">
<meta property="og:url" content="https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/index.html">
<meta property="og:site_name" content="Leriou&#39;s Tavern">
<meta property="og:description" content="海量用户标签的存储方案背景我们在日常的工作中经常遇到这种场景 对一个用户添加许多的标签信息方便对用户身份进行搜索和精细化运营  ps:本文我们不考虑用户身上的标签是怎么来的,只讨论用户已经拥有标签的情况下怎么进行存储  需求分析我们给用户做标签的目的是为了支持更加精细化的运营,算是用户画像的一部分,用户的标签来源可能跟消费,登录,浏览等记录都有关系 我们要做的是可以根据用户身上已经存在的标签,筛选">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2017-12-29T09:47:00.000Z">
<meta property="article:modified_time" content="2017-12-29T09:47:00.000Z">
<meta property="article:author" content="哎呀是太阳嘛">
<meta property="article:tag" content="bitmap">
<meta property="article:tag" content="标签系统">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>使用Bitmap来存储海量用户标签系统</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a href="/categories/">categories</a></li><!--
     --><!--
       --><li><a href="/archives/">archives</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2018-01-01-comic-book-2018/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2017-12-29-programming-languages-are-not-tools/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&text=使用Bitmap来存储海量用户标签系统"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&title=使用Bitmap来存储海量用户标签系统"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&is_video=false&description=使用Bitmap来存储海量用户标签系统"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=使用Bitmap来存储海量用户标签系统&body=Check out this article: https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&title=使用Bitmap来存储海量用户标签系统"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&title=使用Bitmap来存储海量用户标签系统"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&title=使用Bitmap来存储海量用户标签系统"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&title=使用Bitmap来存储海量用户标签系统"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&name=使用Bitmap来存储海量用户标签系统&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&t=使用Bitmap来存储海量用户标签系统"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%B7%E9%87%8F%E7%94%A8%E6%88%B7%E6%A0%87%E7%AD%BE%E7%9A%84%E5%AD%98%E5%82%A8%E6%96%B9%E6%A1%88"><span class="toc-number">1.</span> <span class="toc-text">海量用户标签的存储方案</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bitmap"><span class="toc-number">4.</span> <span class="toc-text">Bitmap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bitmap%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">4.1.</span> <span class="toc-text">Bitmap的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.</span> <span class="toc-text">解决的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-number">4.3.</span> <span class="toc-text">数据处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">4.4.</span> <span class="toc-text">实现方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-number">4.5.</span> <span class="toc-text">预处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8"><span class="toc-number">4.6.</span> <span class="toc-text">存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%93%8D%E4%BD%9C"><span class="toc-number">4.7.</span> <span class="toc-text">查询操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E8%A7%A3%E6%9E%90"><span class="toc-number">4.8.</span> <span class="toc-text">结果解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E6%A0%87%E7%AD%BE%E8%BF%87%E4%BA%8E%E7%A8%80%E7%96%8F%E4%BC%9A%E4%B8%8D%E4%BC%9A%E6%B5%AA%E8%B4%B9%E7%A9%BA%E9%97%B4"><span class="toc-number">5.</span> <span class="toc-text">如果标签过于稀疏会不会浪费空间?</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Google%E7%9A%84EWAHCompressedBitmap"><span class="toc-number">5.1.</span> <span class="toc-text">Google的EWAHCompressedBitmap</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        使用Bitmap来存储海量用户标签系统
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">哎呀是太阳嘛</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2017-12-29T09:47:00.000Z" itemprop="datePublished">2017-12-29</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/bitmap/" rel="tag">bitmap</a>, <a class="tag-link-link" href="/tags/%E6%A0%87%E7%AD%BE%E7%B3%BB%E7%BB%9F/" rel="tag">标签系统</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="海量用户标签的存储方案"><a href="#海量用户标签的存储方案" class="headerlink" title="海量用户标签的存储方案"></a>海量用户标签的存储方案</h1><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>我们在日常的工作中经常遇到这种场景</p>
<p>对一个用户添加许多的标签信息方便对用户身份进行搜索和精细化运营</p>
<blockquote>
<p>ps:本文我们不考虑用户身上的标签是怎么来的,只讨论用户已经拥有标签的情况下怎么进行存储</p>
</blockquote>
<h1 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h1><p>我们给用户做标签的目的是为了支持更加精细化的运营,算是用户画像的一部分,用户的标签来源可能跟消费,登录,浏览等记录都有关系</p>
<p>我们要做的是可以根据用户身上已经存在的标签,筛选出来符合我们需求的用户</p>
<p>我们可以在大量的标签中查找具有某一些标签的用户,或者获取某用户身上的所有标签</p>
<p>我们如果要满足以上的需求, 需要提供以下几个基本接口来方便进行数据查找</p>
<ol>
<li>查找某标签的所有用户以及非该标签的用户</li>
<li>查找某个用户身上的所有标签</li>
<li>判断某个用户是否有某个标签</li>
</ol>
<p>一般来说对以上需求,对于用户和用户身上的标签数据,如果我们采用数据库来进行存储</p>
<p>可能会采用以下方式(为了方便我们模拟了7个用户,7个标签,以下测试都基于该假数据),例如:</p>
<ol>
<li>使用字段标识标签信息</li>
</ol>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">name</th>
<th align="left">vip</th>
<th align="left">mobile</th>
<th align="left">email</th>
<th align="left">male</th>
<th align="left">mac</th>
<th align="left">supervip</th>
<th align="left">lost</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">小明</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">小花</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">小江</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">小红</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">小九</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left">小七</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left">小四</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
</tbody></table>
<p>或者是这样</p>
<ol start="2">
<li>使用记录标识标签信息</li>
</ol>
<table>
<thead>
<tr>
<th align="left">tag</th>
<th align="left">uid</th>
<th align="left">result</th>
</tr>
</thead>
<tbody><tr>
<td align="left">vip</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">mobile</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">email</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">male</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">mac</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">supervip</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">lost</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">vip</td>
<td align="left">2</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">mobile</td>
<td align="left">2</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">email</td>
<td align="left">2</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">male</td>
<td align="left">2</td>
<td align="left">0</td>
</tr>
</tbody></table>
<p>以上两种方式功能上都可以达到我们想要的效果,但第一种方式在标签数量非常多的时候明显是不合适的,我们不可能给每个标签都添加一个字段,那样性能和扩展性都损失非常大</p>
<p>在上面的两个表中第二个表相当于对第一个表进行了拆分,增强了标签的扩展性.如果我们采用第二种方式存储,对于上面的需求 1,2,3 都能很好的满足</p>
<p>但是方式2依然有两个可能遇到的问题</p>
<ol>
<li>我们要查找在某一些标签的用户需要使用如下sql</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    uid </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    tag_table </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> <span class="number">1</span> </span><br><span class="line"><span class="keyword">and</span> tag <span class="keyword">in</span> (<span class="string">&#x27;vip&#x27;</span>,<span class="string">&#x27;mobile&#x27;</span>,<span class="string">&#x27;email&#x27;</span>,<span class="string">&#x27;male&#x27;</span>,<span class="string">&#x27;supervip&#x27;</span>,<span class="string">&#x27;lost&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这样的语句在标签数万甚至数十万的时候对性能影响会非常大</p>
<ol start="2">
<li>存储: 因为每个行记录同时标明了用户,标签,和结果, 所以其中的重复数据非常的多,对数据库存储是个极大地浪费</li>
</ol>
<h1 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h1><h2 id="Bitmap的概念"><a href="#Bitmap的概念" class="headerlink" title="Bitmap的概念"></a>Bitmap的概念</h2><p>Bitmap 翻译做中文称为”位图”, 其核心里面是充分利用一部分数据本身就存在的元属性(空间&#x2F;位置&#x2F;容量)信息,我们这里主要是使用其中的每一位的位置信息,达到使用一个信息表达两种含义的作用</p>
<p>其实就也是一种特殊的编码(coding)过程(或者叫多工(multiplex))</p>
<h2 id="解决的问题"><a href="#解决的问题" class="headerlink" title="解决的问题"></a>解决的问题</h2><p>bitmap可以用来有效解决两类问题</p>
<ol>
<li>存储大量值可以用布尔值标识的数据</li>
<li>部分有用到交,并,差等集合运算的数据</li>
</ol>
<p>第一个特性主要是利用位存储的节省空间的特性,第二个是利用计算机位运算比较快速的特性</p>
<p>eg: </p>
<ol>
<li><p>以前的搜索引擎爬虫在处理网页爬取的时候需要给已经爬取过的网页做标记,避免陷入死循环的重复爬取,当时的搜索网站的爬虫就有一些采用过bitmap来给爬取过的网页做标记,大致就是取页面的url取hash,然后处理成数字,把对应的数字位置为1</p>
</li>
<li><p>微博里面你关注的A也关注了B, 使用B的粉丝列表和你的关注列表进行交集运算就可以了,同样 购买这件商品的人也购买了M,也可以用 购买这件商品的用户列表里面取某个用户购买过的某个商品即可</p>
</li>
</ol>
<p>以上应用确实能有效的减少数据的存储容量和提高集合计算速度, 如果我们用这种方法来存储用户标签信息也能大量减少存储容量</p>
<p>但是怎么把用户标签的表信息数据转换成bitmap形式的数据呢?</p>
<h2 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h2><p>我们如果要记录一个用户对应的一个标签的信息,假如我们知道5号用户是小九,而她是一位超级会员用户(我们可以在上面的表中查到该信息)</p>
<p>我们要如何使用bitmap来表示这条信息呢</p>
<ul>
<li>存储用户和标签的关系</li>
</ul>
<p>我们可以这样:</p>
<ol>
<li>使用一个键<code>user:supervip</code>来记录所有用户是否是超级会员的信息,这个值最初是空的字符串值,表明没有超级会员用户</li>
<li>我们为了标明 5 号用户是超级会员 可以使用这个键中对应位置的二进制位来表明会员的身份,将这个键的第 5 位置为1, 这样这个<code>user:supervip</code>值现在是’000001’(从第0位开始计算)</li>
<li>同样,如果<code>user:supervip</code>的值现在是’01001010’ 我们就可以知道 1,4,6号用户都是超级会员用户</li>
</ol>
<p>我们根据这个数据可以做到2点:</p>
<ul>
<li><p>我们可以根据该标签数据键的对应位置的二进制位的值来判断以该位置为id的用户的标签结果</p>
</li>
<li><p>也可以查询某个标签下的所有用户</p>
</li>
</ul>
<p>这样我们存储上万个标签也只需要上万个键</p>
<ul>
<li>存储所有用户</li>
</ul>
<p>但是我们如果需要查找不属于某个标签的用户怎么办啊,如果直接对上一个例子取反肯定是不行的</p>
<p>为了解决这个问题我们需要一个存储所有用户的键</p>
<p>我们知道了所有用户,知道了拥有某标签的用户</p>
<pre><code>不含某标签的用户 = 总用户 - 含有某标签的用户
</code></pre>
<p>用二进制的操作方法就是使用<code>异或</code>, 举例:</p>
<p>我们有7个用户(编号1-7),5号用户是超级vip,我们要查找所有不是vip的用户可以使用下面的运算</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01111111</span> ^ <span class="number">00001000</span> = <span class="number">01110111</span> <span class="comment">// 127 ^ 8 = 119</span></span><br><span class="line"><span class="comment">// 01111111:所有用户的二进制键  00001000:5号用户是超级会员的键 01110111:所有不是超级会员的用户</span></span><br></pre></td></tr></table></figure>
<p>以上操作我们就能得到所有不是超级会员的用户</p>
<ul>
<li>存储某用户的所有标签</li>
</ul>
<p>我们如果要获得用户的所有标签,也可以将用户拥有的标签id在用户标签键中所对应的位置置为1,这样每一个用户的表示所有标签的键的最大位长度就是固定的,比如:</p>
<p>我们可以用如下方式存储用户的所有标签</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usertag:all:<span class="number">1</span> =&gt; <span class="number">01101010</span>  <span class="comment">// 1号用户的所有标签</span></span><br><span class="line">usertag:all:<span class="number">5</span> =&gt; <span class="number">00010110</span>  <span class="comment">// 5号用户的所有标签</span></span><br></pre></td></tr></table></figure>

<p>这样我们就能使用bitmap来满足以上基本查询需求</p>
<p>同样我们也可以将所有标签存储成一个<code>usertag:alltag</code>键, 再使用异或运算计算某用户不含有的标签</p>
<h2 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h2><p>我们如果自己来对位运算做管理就有点麻烦了,我们可以借助<code>redis</code></p>
<p><code>redis</code>原生提供了可以对字符串进行位操作的命令,具体如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">SETBIT key pos value  // 将 key 的第 pos 位设为 value(只能取1/0)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">GETBIT key pos        // 获取 key 的第 pos 位的值</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">BITOP cmd key1 key2 key3 ... // 对 key2,key3 等执行</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">BITOP AND destkey srckey1 srckey2 srckey3 ... srckeyN</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">BITOP OR destkey srckey1 srckey2 srckey3 ... srckeyN</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">BITOP XOR destkey srckey1 srckey2 srckey3 ... srckeyN</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">BITOP NOT destkey srckey</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">BITPOS key bit start end  // 将 key 的 strat 到 end 位全部设为 bit(0/1)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">BITCOUNT mykey 1 1</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">BITFIELD mystring SET i8 <span class="comment">#0 100 i8 #1 200</span></span></span><br></pre></td></tr></table></figure>

<p>我们就直接使用<code>redis</code>来存储数据了,这样方便点</p>
<h2 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h2><p>我们这边为了方便直接使用redis提供的<code>setbit</code>,<code>getbit</code>和<code>bitop</code>来进行字符串的位操作</p>
<p>因为我们要存储用户标签,所以我们首先需要对用户和标签进行编号,这样我们需要两个表</p>
<p>用户表:</p>
<table>
<thead>
<tr>
<th align="left">uid</th>
<th align="left">name</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">小明</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">小花</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">小江</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">小红</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">小九</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left">小七</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left">小四</td>
</tr>
</tbody></table>
<p>标签表:</p>
<table>
<thead>
<tr>
<th align="left">tid</th>
<th align="left">name</th>
<th align="left">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">vip</td>
<td align="left">是否vip</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">mobile</td>
<td align="left">是否绑定手机</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">email</td>
<td align="left">是否绑定邮箱</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">male</td>
<td align="left">是否男性</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">mac</td>
<td align="left">是否使用Mac</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left">supervip</td>
<td align="left">是否年费会员</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left">lost</td>
<td align="left">是否易流失用户</td>
</tr>
</tbody></table>
<h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><p>我们这里为了性能考虑使用redis来进行存储</p>
<p>我们将最上面的表格数据转换成以下键值对</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 所有用户</span></span><br><span class="line">    <span class="attr">&quot;user:all&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;01111111&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 所有vip用户</span></span><br><span class="line">    <span class="attr">&quot;user:vip&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;01001001&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 所有绑定了手机的用户</span></span><br><span class="line">    <span class="attr">&quot;user:mobile&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;01101010&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 所有绑定了邮箱的用户</span></span><br><span class="line">    <span class="attr">&quot;user:email&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;00001010&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 所有男性用户</span></span><br><span class="line">    <span class="attr">&quot;user:male&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;01010011&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 用户1的所有标签</span></span><br><span class="line">    <span class="attr">&quot;usertag:all:1&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;01101010&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">//用户2的所有标签</span></span><br><span class="line">    <span class="attr">&quot;usertag:all:2&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;00100001&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="查询操作"><a href="#查询操作" class="headerlink" title="查询操作"></a>查询操作</h2><p>我们可以使用redis的命令<code>getbit</code>来查询某个键的某个位置的值<br>比如,我们要查询5号用户是否具有vip标签,可以使用以下命令   </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ getbit user:vip <span class="number">5</span> <span class="comment">// 返回 0</span></span><br></pre></td></tr></table></figure>
<p>要查询某用户身上的所有标签可以使用如下   </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ get usertag:all:<span class="number">1</span> <span class="comment">// 获取用户1的所有标签 返回&#x27;01101010&#x27;</span></span><br></pre></td></tr></table></figure>
<p>我们如果要获取某标签下的所有用户可以使用如下命令   </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">get user:vip // 返回一个二进制字符串 类似 <span class="string">&#x27;01001001&#x27;</span></span></span><br></pre></td></tr></table></figure>
<p>查询不具有某个标签的用户   </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bitop xor user:not_vip user:all user:vip // 根据所有用户和具有标签的用户进行异或运算,得到不含有某标签的用户</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">get user:not_vip // 返回二进制字符串</span></span><br></pre></td></tr></table></figure>

<p>我们现在知道如何快速的获取我们想要的数据了,但是我们发现有时候我们获取到的都是二进制的数据例如 <code>00001000</code> 这种,而群殴们想从这样的数据中获取的是 <code>[5]</code> 这样的比较易读的信息</p>
<p>我们需要有一个将二进制字符串 转化为对应位置为1的位置数组的形式</p>
<p>如: function(<code>01001010</code>) &#x3D;&gt; <code>[1,4,6]</code> </p>
<h2 id="结果解析"><a href="#结果解析" class="headerlink" title="结果解析"></a>结果解析</h2><p>这里我们提供两个函数来进行这样的操作</p>
<ol>
<li>遍历法</li>
</ol>
<p>我们遍历二进制字符串中的每一位, 每遇到一个为1的位置就将该位置放入数组</p>
<p>这种方法比较慢,不建议使用,这里贴一个示例代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">key2array</span>(<span class="params">self, key</span>):  <span class="comment"># 将二进制(&#x27;\x05&#x27;-&gt;&#x27;0b00000101&#x27;)变为数组[5,7], 表示第五位和第七位为1</span></span><br><span class="line">    tmpstr = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">bin</span>(i).replace(<span class="string">&#x27;0b&#x27;</span>, <span class="string">&#x27;&#x27;</span>).zfill(<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> key])</span><br><span class="line">    arr = []</span><br><span class="line">    str_len = <span class="built_in">len</span>(tmpstr)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, str_len):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(tmpstr[i]) == <span class="number">1</span>:</span><br><span class="line">            arr.append(i)</span><br><span class="line">    <span class="keyword">return</span> (arr)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>查表</li>
</ol>
<p>我们可以观察一下redis返回的二进制数据的特点, 每8个二进制位属于一个字节,每个字节都可以表示成具体的数字(如:0,23,127)这个数字最大也只能到255,而且同一个数字有可能出现非常多次,而每个数字所对应的转换过后的位置数组都是固定的,比如: 100(二进制:1100100) &#x3D;&gt; [1,2,5]</p>
<p>我们可以利用这一点,提前制作一个 <code>0-255</code>的所对应的位置表,然后每次处理8位,处理完把当前处理的位数加上新表中对应的值就可以快速的得到这个值了</p>
<blockquote>
<p>ps: 我们也可以扩大这个表的容量以提高速度</p>
</blockquote>
<p>贴下示例代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">build_bit_table</span>(<span class="params">self</span>):  <span class="comment"># 生成0-255的表</span></span><br><span class="line">    arr = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">256</span>):</span><br><span class="line">        tmp_arr = []</span><br><span class="line">        tstr = <span class="built_in">bin</span>(i).replace(<span class="string">&#x27;0b&#x27;</span>, <span class="string">&#x27;&#x27;</span>).zfill(<span class="number">8</span>)</span><br><span class="line">        n = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> tstr:</span><br><span class="line">            n = n + <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">int</span>(k) == <span class="number">1</span>:</span><br><span class="line">                tmp_arr.append(n)</span><br><span class="line">        arr.append(tmp_arr)</span><br><span class="line">    self.bit_table = arr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">key2array</span>(<span class="params">self, key</span>):  <span class="comment"># 查表法</span></span><br><span class="line">    arr = []</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">        pos = self.bit_table[i]</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> pos:</span><br><span class="line">            arr.append(n + k - <span class="number">1</span>)</span><br><span class="line">        n = n + <span class="number">8</span></span><br><span class="line">    <span class="keyword">return</span> (arr)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ps:jdk中的BitSet就是对bitmap的一种简单实现</p>
</blockquote>
<h1 id="如果标签过于稀疏会不会浪费空间"><a href="#如果标签过于稀疏会不会浪费空间" class="headerlink" title="如果标签过于稀疏会不会浪费空间?"></a>如果标签过于稀疏会不会浪费空间?</h1><p>如果我们在一个很长的bitmap中只存除了极少量的数据是不是会对空间造成浪费呢?</p>
<p>例如: 在bitmap的第40000位置为1,那存储的数据大概就类似: 00000000000…0000000001</p>
<p>这样的数据前面的39999位都是0,不会浪费空间吗</p>
<h2 id="Google的EWAHCompressedBitmap"><a href="#Google的EWAHCompressedBitmap" class="headerlink" title="Google的EWAHCompressedBitmap"></a>Google的EWAHCompressedBitmap</h2><p>Google的EWAHCompressedBitmap就对这种情况做了优化</p>
<p>EWAHCompressedBitmap 将整个的二进制数据分成每64位一个的word</p>
<p>一个空的Bitmap默认拥有 4 个word 也就是 <code>4*64</code> 位</p>
<p>其中 word0 存储bitmap的头信息</p>
<p>当我们改变对应位置的比特位的值时 word 会跟着变化</p>
<p>当我们插入的值非常大的时候(例如:40000), 算法会根据当前的值 创建两个新的word </p>
<p>一个用于存储第40000个数据所在的word的信息(LW), 还有一个存储跨度信息(称为:跨度word &#x2F;RLW )</p>
<p>假如说我们给一个空的bitmap,我们插入40000的话正常情况下会有6个word,前4个是头信息word+3个空word,第6个中保存40000这个数字所在的位置信息,第5个word中保存从第 4-625 word的跨度信息,第626word中存储有 40000 这个数据 </p>
<blockquote>
<p>ps: 第一个word存储头信息, 625 &#x3D; floor( (40000 + 1) &#x2F; 64 ) </p>
</blockquote>
<p>存储跨度信息的word和普通的存储数据的word虽然空间一样但是存储的内容不一样,存储跨度信息的word大概内容这样</p>
<pre><code>前32位存储 `当前跨度word(RLW)横跨了多少空word`    
后32位存储 `当前跨度word(RLW)后方有多少个连续的LW`
</code></pre>
<p>当我们存储 位置在跨度word(RLW)之中的数据(例如:20000), RLW会进行分裂</p>
<p>变成3个word,中间一个存储20000所在的LW信息,前后各有一个RLW保存新的跨度信息</p>
<p>EWAHCompressedBitmap对应的maven依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.googlecode.javaewah<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>JavaEWAH<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/tags/">tags</a></li>
         
          <li><a href="/categories/">categories</a></li>
         
          <li><a href="/archives/">archives</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%B7%E9%87%8F%E7%94%A8%E6%88%B7%E6%A0%87%E7%AD%BE%E7%9A%84%E5%AD%98%E5%82%A8%E6%96%B9%E6%A1%88"><span class="toc-number">1.</span> <span class="toc-text">海量用户标签的存储方案</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bitmap"><span class="toc-number">4.</span> <span class="toc-text">Bitmap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bitmap%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">4.1.</span> <span class="toc-text">Bitmap的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.2.</span> <span class="toc-text">解决的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-number">4.3.</span> <span class="toc-text">数据处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">4.4.</span> <span class="toc-text">实现方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-number">4.5.</span> <span class="toc-text">预处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8"><span class="toc-number">4.6.</span> <span class="toc-text">存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%93%8D%E4%BD%9C"><span class="toc-number">4.7.</span> <span class="toc-text">查询操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E8%A7%A3%E6%9E%90"><span class="toc-number">4.8.</span> <span class="toc-text">结果解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E6%A0%87%E7%AD%BE%E8%BF%87%E4%BA%8E%E7%A8%80%E7%96%8F%E4%BC%9A%E4%B8%8D%E4%BC%9A%E6%B5%AA%E8%B4%B9%E7%A9%BA%E9%97%B4"><span class="toc-number">5.</span> <span class="toc-text">如果标签过于稀疏会不会浪费空间?</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Google%E7%9A%84EWAHCompressedBitmap"><span class="toc-number">5.1.</span> <span class="toc-text">Google的EWAHCompressedBitmap</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&text=使用Bitmap来存储海量用户标签系统"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&title=使用Bitmap来存储海量用户标签系统"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&is_video=false&description=使用Bitmap来存储海量用户标签系统"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=使用Bitmap来存储海量用户标签系统&body=Check out this article: https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&title=使用Bitmap来存储海量用户标签系统"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&title=使用Bitmap来存储海量用户标签系统"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&title=使用Bitmap来存储海量用户标签系统"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&title=使用Bitmap来存储海量用户标签系统"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&name=使用Bitmap来存储海量用户标签系统&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://leriou.github.io/2017-12-29-user-tag-sys-on-bitmap/&t=使用Bitmap来存储海量用户标签系统"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2022
    哎呀是太阳嘛
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a href="/categories/">categories</a></li><!--
     --><!--
       --><li><a href="/archives/">archives</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
